window.Framework={cache:{},plugins:{},plugin(e,t){this.plugins[e]=t},usePlugin(e,...t){if(this.plugins[e])return this.plugins[e](...t)},async fetchHTML(e){if(this.cache[e])return this.cache[e];try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load ${e}`);const n=await t.text();return this.cache[e]=n,n}catch(t){return console.error(t),`\x3c!-- Error loading ${e} --\x3e`}},async processIncludes(e){const t=/<include\s+src=["']([^"']+)["']([^>]*)>(.*?)<\/include>|<include\s+src=["']([^"']+)["']([^>]*)\/>/gs;let n,s=e;for(;null!==(n=t.exec(s));){const e=n[0],i=n[1]||n[4],r=n[2]||n[5]||"",o=n[3]||"";let a=await this.fetchHTML(i);if(o.trim()){const e={},t=/<slot\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/slot>/g;let n,s=!1;for(;null!==(n=t.exec(o));)e[n[1]]=n[2],s=!0;!s&&o.trim()&&(e.default=o);for(const[t,n]of Object.entries(e)){const e=new RegExp(`<slot\\s+name=["']${t}["']\\s*><\\/slot>|<slot\\s+name=["']${t}["']\\s*\\/>`,"g");a=a.replace(e,n)}e.default&&(a=a.replace(/<slot\s*><\/slot>|<slot\s*\/>/g,e.default))}a=a.replace(/<slot[^>]*><\/slot>|<slot[^>]*\/>/g,"");const l=/(\w+)=["']([^"']*)["']/g;let c;const f={};for(;null!==(c=l.exec(r));)f[c[1]]=c[2];for(const[e,t]of Object.entries(f)){const n=new RegExp(`\\{\\{\\s*${e}\\s*\\}\\}`,"g");a=a.replace(n,t)}a=await this.processIncludes(a),s=s.replace(e,a),t.lastIndex=0}return s},async processLayout(e){const t=/<layout\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/layout>/.exec(e);if(t){const e=t[1],n=t[2],s={},i=/<slot\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/slot>/g;let r;for(;null!==(r=i.exec(n));)s[r[1]]=r[2];let o=await this.fetchHTML(`app/layouts/${e}.html`);for(const[e,t]of Object.entries(s)){const n=new RegExp(`<slot\\s+name=["']${e}["']\\s*><\\/slot>`,"g");o=o.replace(n,t)}return o}return e},transformTemplate:e=>e=(e=(e=(e=(e=e.replace(/\{\{\s*([^}]+)\s*\}\}/g,'<span x-text="$1"></span>')).replace(/{%\s*if\s+([^%]+)\s*%}/g,'<template x-if="$1">')).replace(/{%\s*endif\s*%}/g,"</template>")).replace(/{%\s*for\s+([^%]+)\s*%}/g,'<template x-for="$1">')).replace(/{%\s*endfor\s*%}/g,"</template>"),sanitize:e=>DOMPurify.sanitize(e,{ADD_TAGS:["include","layout","slot","template","span","div"],ADD_ATTR:["x-data","x-text","x-if","x-for","x-bind","x-on","src","name","@click",":class"]}),async fetchJSON(e,t=!0){try{const n=await fetch(e);if(!n.ok)throw new Error(`Failed to load JSON: ${e}`);const s=await n.json();if(t){const e=t=>{if("string"==typeof t)return DOMPurify.sanitize(t);if("object"==typeof t&&null!==t)for(let n in t)t[n]=e(t[n]);return t};return e(s)}return s}catch(e){return console.error(e),null}},async render(e,t){const n=document.getElementById(t);if(!n)return void console.error("Target element not found:",t);let s=await this.fetchHTML(e);if(s=await this.processLayout(s),s=await this.processIncludes(s),s=this.transformTemplate(s),n.innerHTML=s,this.executeScripts(n),window.Alpine)try{if("function"==typeof Alpine.initTree){if("function"==typeof Alpine.destroyTree)try{Alpine.destroyTree(n)}catch(e){}await Alpine.initTree(n)}else"function"==typeof Alpine.init&&Alpine.init()}catch(e){if("function"==typeof Alpine.init)try{Alpine.init()}catch(e){}}},executeScripts(e){e.querySelectorAll("script").forEach(e=>{const t=document.createElement("script");Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(e.innerHTML)),document.head.appendChild(t),document.head.removeChild(t),e.remove()})}},document.addEventListener("alpine:init",()=>{Alpine.data("collection",e=>({items:[],loading:!0,error:null,async init(){this.loading=!0;const t=await Framework.fetchJSON(e);t?this.items=t:this.error="Failed to load data",this.loading=!1}})),Alpine.data("item",(e,t,n)=>({item:null,loading:!0,error:null,async init(){this.loading=!0;const s=await Framework.fetchJSON(e);s?(this.item=s.find(e=>e[t]===n),this.item||(this.error="Item not found")):this.error="Failed to load data",this.loading=!1}}))});