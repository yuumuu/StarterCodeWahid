window.Framework={cache:{},plugins:{},plugin(n,f){this.plugins[n]=f},usePlugin(n,...a){if(this.plugins[n])return this.plugins[n](...a)},async fetchHTML(u){if(this.cache[u])return this.cache[u];try{const r=await fetch(u);if(!r.ok)throw new Error(`Failed to load ${u}`);const h=await r.text();this.cache[u]=h;return h}catch(e){console.error(e);return`<!-- Error loading ${u} -->`}},async processIncludes(h){const r=/<include\s+src=["']([^"']+)["']([^>]*)>(.*?)<\/include>|<include\s+src=["']([^"']+)["']([^>]*)\/>/gs;let m;let p=h;while((m=r.exec(p))!==null){const fm=m[0];const src=m[1]||m[4];const attrs=m[2]||m[5]||"";const inner=m[3]||"";let ch=await this.fetchHTML(src);if(inner.trim()){const slots={};const sr=/<slot\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/slot>/g;let sm;let hns=false;while((sm=sr.exec(inner))!==null){slots[sm[1]]=sm[2];hns=true}if(!hns&&inner.trim())slots["default"]=inner;for(const[n,c]of Object.entries(slots)){const tr=new RegExp(`<slot\\s+name=["']${n}["']\\s*><\\/slot>|<slot\\s+name=["']${n}["']\\s*\\/>`,"g");ch=ch.replace(tr,c)}if(slots["default"])ch=ch.replace(/<slot\s*><\/slot>|<slot\s*\/>/g,slots["default"])}ch=ch.replace(/<slot[^>]*><\/slot>|<slot[^>]*\/>/g,"");const ar=/(\w+)=["']([^"']*)["']/g;let am;const props={};while((am=ar.exec(attrs))!==null)props[am[1]]=am[2];for(const[k,v]of Object.entries(props)){const pr=new RegExp(`\\{\\{\\s*${k}\\s*\\}\\}`, "g");ch=ch.replace(pr,v)}ch=await this.processIncludes(ch);p=p.replace(fm,ch);r.lastIndex=0}return p},async processLayout(h){const lr=/<layout\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/layout>/;const m=lr.exec(h);if(m){const ln=m[1];const c=m[2];const slots={};const sr=/<slot\s+name=["']([^"']+)["']\s*>([\s\S]*?)<\/slot>/g;let sm;while((sm=sr.exec(c))!==null)slots[sm[1]]=sm[2];let lh=await this.fetchHTML(`app/layouts/${ln}.html`);for(const[n,sc]of Object.entries(slots)){const tr=new RegExp(`<slot\\s+name=["']${n}["']\\s*><\\/slot>`,"g");lh=lh.replace(tr,sc)}return lh}return h},transformTemplate(h){h=h.replace(/\{\{\s*([^}]+)\s*\}\}/g,'<span x-text="$1"></span>');h=h.replace(/{%\s*if\s+([^%]+)\s*%}/g,'<template x-if="$1">');h=h.replace(/{%\s*endif\s*%}/g,"</template>");h=h.replace(/{%\s*for\s+([^%]+)\s*%}/g,'<template x-for="$1">');h=h.replace(/{%\s*endfor\s*%}/g,"</template>");return h},sanitize(h){return DOMPurify.sanitize(h,{ADD_TAGS:["include","layout","slot","template","span","div"],ADD_ATTR:["x-data","x-text","x-if","x-for","x-bind","x-on","src","name","@click",":class"]})},async fetchJSON(u,s=true){try{const r=await fetch(u);if(!r.ok)throw new Error(`Failed: ${u}`);const d=await r.json();if(s){const sv=v=>{if(typeof v==="string")return DOMPurify.sanitize(v);if(typeof v==="object"&&v!==null)for(let k in v)v[k]=sv(v[k]);return v};return sv(d)}return d}catch(e){console.error(e);return null}},async render(cp,tid){console.log("[Framework] Render:",cp);const t=document.getElementById(tid);if(!t)return;let h=await this.fetchHTML(cp);h=await this.processLayout(h);h=await this.processIncludes(h);h=this.transformTemplate(h);t.innerHTML=h;this.executeScripts(t);if(window.Alpine){try{if(typeof Alpine.initTree==="function"){if(typeof Alpine.destroyTree==="function")try{Alpine.destroyTree(t)}catch(e){}await Alpine.initTree(t)}else Alpine.init()}catch(e){if(typeof Alpine.init==="function")try{Alpine.init()}catch(err){}}}console.log("[Framework] Done:",cp)},executeScripts(c){const s=c.querySelectorAll("script");s.forEach(os=>{const ns=document.createElement("script");Array.from(os.attributes).forEach(a=>ns.setAttribute(a.name,a.value));ns.appendChild(document.createTextNode(os.innerHTML));document.head.appendChild(ns);document.head.removeChild(ns);os.remove()})}};document.addEventListener("alpine:init",()=>{Alpine.data("collection",u=>({items:[],loading:true,error:null,async init(){this.loading=true;const d=await Framework.fetchJSON(u);if(d)this.items=d;else this.error="Failed";this.loading=false}}));Alpine.data("item",(u,k,v)=>({item:null,loading:true,error:null,async init(){this.loading=true;const d=await Framework.fetchJSON(u);if(d){this.item=d.find(i=>i[k]===v);if(!this.item)this.error="Not found"}else this.error="Failed";this.loading=false}}))});
